from typing import List
import re


def _unique_preserve(seq: List[str]) -> List[str]:
    seen = set()
    out: List[str] = []
    for s in seq:
        if s not in seen:
            seen.add(s)
            out.append(s)
    return out


def decode_barcodes(image_path: str) -> List[str]:
    """
    Decode barcodes from an image using pyzbar.

    Returns a list of normalized numeric barcodes (digits only),
    preserving detection order and removing duplicates.
    """
    try:
        from PIL import Image
        from pyzbar.pyzbar import decode
    except Exception as e:
        print(f"[Barcode] ❌ Missing dependencies for barcode decoding: {e}")
        return []

    try:
        img = Image.open(image_path)
    except Exception as e:
        print(f"[Barcode] ❌ Cannot open image: {e}")
        return []

    try:
        results = decode(img)
    except Exception as e:
        print(f"[Barcode] ❌ Decode error: {e}")
        return []

    codes: List[str] = []
    for r in results:
        try:
            raw = r.data.decode(errors="ignore") if getattr(r, "data", None) else ""
        except Exception:
            raw = str(getattr(r, "data", b""))
        # Keep digits only; common barcodes are EAN/UPC/CODE128 numeric
        norm = re.sub(r"\D+", "", raw or "")
        if norm and 6 <= len(norm) <= 20:
            codes.append(norm)

    codes = _unique_preserve(codes)
    print(f"[Barcode] ✅ Detected codes: {codes}")
    return codes

